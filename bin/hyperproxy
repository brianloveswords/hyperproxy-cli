#!/usr/bin/env node
require('colors')
const util = require('util')
const path = require('path')
const argv = require('optimist').argv

const configFile = argv._[0] ||
  path.join(process.cwd(), 'servers.json')

const port = argv.p || argv.port

if (!port) {
  console.error('must specify a port with -p or --port')
  process.exit(1)
}

try {
  const config = require(configFile)
} catch (e) {
  console.error('could not open config file, %s', configFile)
  process.exit(1)
}

const Hyperproxy = require('hyperproxy')

const server =
  new Hyperproxy({ servers: config })
  .createServer()
  .listen(port)
  .on('proxyError', function (err) {
    console.dir(err)
  })



server.on('listening', function () {
  console.log('')
  console.log(util.format('Listening on port %s, routing to server:', this.address().port).green)
  console.log('------------------------------------------------------------------------'.cyan)
  console.dir(config)
  console.log('------------------------------------------------------------------------'.cyan)
  console.log('')
})
